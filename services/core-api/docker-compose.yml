version: "3.9"

services:
  afribrok-db:
    image: postgis/postgis:15-3.4
    container_name: srv-captain--afribrok-db
    environment:
      POSTGRES_USER: afribrok
      POSTGRES_PASSWORD: pass
      POSTGRES_DB: afribrok_db
    ports: ["5432:5432"]
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U afribrok -d afribrok_db"]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped
    networks: [stack]

  afribrok-redis:
    image: redis:7-alpine
    container_name: srv-captain--afribrok-redis
    command: ["redis-server", "--requirepass", "pass"]
    ports: ["6379:6379"]
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "pass", "PING"]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped
    networks: [stack]

  core-api:
    build:
      context: ../..                  # root of repository
      dockerfile: services/core-api/Dockerfile
      # Ensure consistent platform builds (uncomment and set to your deployment platform)
      # platform: linux/amd64  # Use for x86_64 servers
      # platform: linux/arm64  # Use for ARM64 servers (e.g., Apple Silicon, AWS Graviton)
    environment:
      NODE_ENV: development           # local
      PORT: 8080
      DATABASE_URL: postgresql://afribrok:pass@srv-captain--afribrok-db:5432/afribrok_db?sslmode=disable
      REDIS_URL: redis://:pass@srv-captain--afribrok-redis:6379/0

      # ⚠️ For local, don't point at production Keycloak.
      # Use a local issuer or temporarily relax verification if your API supports it.
      JWT_ISSUER: http://localhost:8080/dev-issuer
      JWT_AUDIENCE: afribrok-api
      OIDC_ISSUER: http://localhost:8080/dev-issuer
      OIDC_ISSUER_URL: http://localhost:8080/dev-issuer

      # CORS for local UIs (adjust as needed)
      CORS_ALLOWED_ORIGINS: http://localhost:3000,http://localhost:5173,http://localhost:8081

      # AWS S3 configuration (defaults are placeholders; override with real values)
      STORAGE_ENDPOINT: https://s3.amazonaws.com
      STORAGE_BUCKET: local-media
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: local
      AWS_SECRET_ACCESS_KEY: local-secret
      OIDC_CLIENT_ID: local-client
      OIDC_CLIENT_SECRET: local-secret
      TELEBIRR_SANDBOX_API_KEY: sandbox-key
      TELEBIRR_SANDBOX_SECRET: sandbox-secret

    ports: ["8080:8080"]
    depends_on:
      afribrok-db:
        condition: service_healthy
      afribrok-redis:
        condition: service_healthy
    restart: unless-stopped
    networks: [stack]

networks:
  stack:
    driver: bridge

volumes:
  pgdata:
