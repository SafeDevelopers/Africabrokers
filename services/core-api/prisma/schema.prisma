generator client {
  provider = "prisma-client-js"
  previewFeatures = ["fieldReference"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  SUPER_ADMIN
  TENANT_ADMIN
  AGENT
  INSPECTOR
  BROKER
  BUYER
}

enum UserStatus {
  ACTIVE
  SUSPENDED
}

enum BrokerApplicationStatus {
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  NEEDS_INFO
}

enum LicenseStatus {
  APPROVED
  SUSPENDED
  EXPIRED
  REVOKED
  PENDING
}

enum ListingStatus {
  DRAFT
  PENDING_REVIEW
  PUBLISHED
  FLAGGED
  UNLISTED
  EXPIRED
}

enum QrCodeSubjectType {
  BROKER
  LISTING
}

enum QrCodeStatus {
  ACTIVE
  REVOKED
}

enum InspectionEventType {
  VERIFICATION
  COMPLIANCE_CHECK
  VIOLATION
  OTHER
}

enum InspectionEventStatus {
  OPEN
  CLOSED
}

// Models
model Tenant {
  id        String   @id @default(uuid())
  slug      String   @unique
  name      String
  country   String
  locales   Json     // Array of locale strings
  policies  Json     // Tenant-specific policies
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  agentOffices         AgentOffice[]
  users                User[]
  brokerApplications   BrokerApplication[]
  licenses             License[]
  listings             Listing[]
  qrCodes              QrCode[]
  inspectionEvents     InspectionEvent[]
  auditLogs            AuditLog[]

  @@index([slug])
}

model AgentOffice {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  city      String
  isCapital Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users User[]

  @@index([tenantId])
}

model User {
  id             String     @id @default(uuid())
  tenantId       String
  tenant         Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  agentOfficeId String?
  agentOffice    AgentOffice? @relation(fields: [agentOfficeId], references: [id])
  email          String     @unique
  role           UserRole
  status         UserStatus @default(ACTIVE)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  // Relations
  brokerApplications BrokerApplication[]
  licenses           License[]
  inspectionEvents   InspectionEvent[]
  auditLogs          AuditLog[]

  @@index([tenantId])
  @@index([email])
  @@index([agentOfficeId])
}

model BrokerApplication {
  id         String                  @id @default(uuid())
  tenantId   String
  tenant     Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId     String
  user       User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  payload    Json                    // Application form data
  status     BrokerApplicationStatus @default(SUBMITTED)
  submittedAt DateTime                @default(now())
  createdAt  DateTime                @default(now())
  updatedAt  DateTime               @updatedAt

  @@index([tenantId])
  @@index([userId])
  @@index([status])
}

model License {
  id            String        @id @default(uuid())
  tenantId      String
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  brokerUserId  String
  broker        User          @relation(fields: [brokerUserId], references: [id], onDelete: Cascade)
  licenseNo    String
  issuedAt     DateTime
  expiresAt    DateTime?
  status       LicenseStatus @default(PENDING)
  createdAt     DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([tenantId])
  @@index([brokerUserId])
  @@index([licenseNo])
  @@index([status])
}

model Listing {
  id         String        @id @default(uuid())
  tenantId   String
  tenant     Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  ownerUserId String
  category   String
  attrs      Json          // Listing attributes (price, area, bedrooms, etc.)
  status     ListingStatus @default(DRAFT)
  publishedAt DateTime?
  expiresAt   DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([tenantId])
  @@index([ownerUserId])
  @@index([status])
  @@index([publishedAt])
}

model QrCode {
  id             String           @id @default(uuid())
  tenantId       String
  tenant         Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  code           String           @unique
  subjectType    QrCodeSubjectType
  subjectId      String
  status         QrCodeStatus     @default(ACTIVE)
  scanCount      Int              @default(0)
  lastScannedAt  DateTime?
  createdAt      DateTime         @default(now())
  revokedAt      DateTime?

  @@index([tenantId])
  @@index([code])
  @@index([subjectType, subjectId])
}

model InspectionEvent {
  id         String                @id @default(uuid())
  tenantId   String
  tenant     Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  inspectorUserId String
  inspector User                   @relation(fields: [inspectorUserId], references: [id], onDelete: Cascade)
  subjectType String               // "BROKER" or "LISTING"
  subjectId   String
  type        InspectionEventType
  notes       String?
  geo         Json?                // { latitude, longitude }
  photos      Json?                // Array of photo URLs
  status      InspectionEventStatus @default(OPEN)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  @@index([tenantId])
  @@index([inspectorUserId])
  @@index([subjectType, subjectId])
  @@index([status])
}

model AuditLog {
  id         String   @id @default(uuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  actorUserId String?
  actor      User?    @relation(fields: [actorUserId], references: [id])
  entityType String
  entityId   String
  action     String
  before     Json?
  after      Json?
  createdAt  DateTime @default(now())

  @@index([tenantId])
  @@index([actorUserId])
  @@index([entityType, entityId])
  @@index([createdAt])
}
