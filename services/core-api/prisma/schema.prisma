generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fieldReference"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  SUPER_ADMIN
  TENANT_ADMIN
  AGENT
  INSPECTOR
  BROKER
  BUYER
}

enum UserStatus {
  ACTIVE
  SUSPENDED
}

enum BrokerApplicationStatus {
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  NEEDS_INFO
}

enum LicenseStatus {
  APPROVED
  SUSPENDED
  EXPIRED
  REVOKED
  PENDING
}

enum BrokerStatus {
  draft
  submitted
  approved
  denied
  suspended
}

enum PropertyType {
  residential
  commercial
  land
}

enum VerificationStatus {
  draft
  pending
  verified
  rejected
}

enum ListingAvailability {
  active
  pending_review
  suspended
  closed
}

enum ReviewDecision {
  pending
  approved
  denied
  needs_more_info
}

enum QrCodeStatus {
  active
  revoked
}

enum InspectionStatus {
  pending_sync
  synced
  archived
}

enum PaymentProviderType {
  STRIPE
  TELEBIRR
  MPESA
  CASH
}

enum SubscriptionStatus {
  active
  canceled
  past_due
  trialing
  unpaid
}

enum InvoiceStatus {
  draft
  open
  paid
  void
  uncollectible
}

enum PaymentIntentStatus {
  requires_payment_method
  requires_confirmation
  requires_action
  processing
  requires_capture
  canceled
  succeeded
}

enum DunningAction {
  none
  cancel
  suspend
  send_notice
}

// Models
model Tenant {
  id          String   @id @default(uuid())
  slug        String   @unique
  key         String   @unique
  name        String
  country     String
  locales     Json
  policies    Json
  brandConfig Json?
  currency    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  agentOffices       AgentOffice[]
  users              User[]
  brokers            Broker[]
  brokerApplications BrokerApplication[]
  licenses           License[]
  properties         Property[]
  listings           Listing[]
  qrCodes            QrCode[]
  kycReviews         KycReview[]
  inspections        Inspection[]
  auditLogs          AuditLog[]
  paymentProviders   PaymentProvider[]
  plans              Plan[]
  subscriptions      Subscription[]
  invoices           Invoice[]
  paymentIntents     PaymentIntent[]
  dunningRules       DunningRule[]
  leads              Lead[]
  tenantPolicy       TenantPolicy?

  @@index([slug])
}

model AgentOffice {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  city      String
  isCapital Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users User[]

  @@index([tenantId])
}

model User {
  id             String       @id @default(uuid())
  tenantId       String
  tenant         Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  agentOfficeId  String?
  agentOffice    AgentOffice? @relation(fields: [agentOfficeId], references: [id])
  email          String       @unique
  authProviderId String?
  emailHash      String?
  role           UserRole
  status         UserStatus   @default(ACTIVE)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  brokerApplications BrokerApplication[]
  brokers            Broker[]
  licenses           License[]
  inspections        Inspection[]        @relation("InspectorInspections")
  reviewsAuthored    KycReview[]         @relation("ReviewerReviews")
  auditLogs          AuditLog[]

  @@index([tenantId])
  @@index([email])
  @@index([agentOfficeId])
}

model BrokerApplication {
  id           String                  @id @default(uuid())
  tenantId     String
  tenant       Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId       String
  user         User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  payload      Json
  orgType      String? // Organization type: "Government / Public", "Private / Association", or "Other"
  orgTypeNotes String? // Notes when orgType is "Other"
  status       BrokerApplicationStatus @default(SUBMITTED)
  submittedAt  DateTime                @default(now())
  createdAt    DateTime                @default(now())
  updatedAt    DateTime                @updatedAt

  @@index([tenantId])
  @@index([userId])
  @@index([status])
}

model License {
  id           String        @id @default(uuid())
  tenantId     String
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  brokerUserId String
  broker       User          @relation(fields: [brokerUserId], references: [id], onDelete: Cascade)
  licenseNo    String
  issuedAt     DateTime
  expiresAt    DateTime?
  status       LicenseStatus @default(PENDING)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([tenantId])
  @@index([brokerUserId])
  @@index([licenseNo])
  @@index([status])
}

model Broker {
  id            String       @id @default(uuid())
  tenantId      String
  tenant        Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId        String
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  licenseNumber String
  licenseDocs   Json
  businessDocs  Json?
  status        BrokerStatus @default(draft)
  rating        Float?       @default(0)
  strikeCount   Int          @default(0)
  submittedAt   DateTime?
  approvedAt    DateTime?
  qrCodeId      String?      @unique
  qrCode        QrCode?      @relation("BrokerQrCode", fields: [qrCodeId], references: [id])
  kycReviews    KycReview[]
  properties    Property[]
  listings      Listing[]
  inspections   Inspection[]
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@unique([tenantId, licenseNumber])
  @@index([tenantId])
  @@index([userId])
}

model Property {
  id                 String             @id @default(uuid())
  tenantId           String
  tenant             Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  brokerId           String?
  broker             Broker?            @relation(fields: [brokerId], references: [id])
  type               PropertyType
  address            Json
  latitude           Float?
  longitude          Float?
  verificationStatus VerificationStatus @default(draft)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  listings           Listing[]

  @@index([tenantId])
  @@index([brokerId])
}

model Listing {
  id                 String              @id @default(uuid())
  tenantId           String
  tenant             Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  propertyId         String
  property           Property            @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  brokerId           String?
  broker             Broker?             @relation(fields: [brokerId], references: [id])
  priceAmount        Decimal             @db.Decimal(12, 2)
  priceCurrency      String
  availabilityStatus ListingAvailability @default(pending_review)
  channels           Json
  attrs              Json?
  featured           Boolean             @default(false)
  fraudScore         Float?              @default(0)
  publishedAt        DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  @@index([tenantId])
  @@index([propertyId])
  @@index([brokerId])
  @@index([availabilityStatus])
  @@index([publishedAt])
}

model KycReview {
  id         String         @id @default(uuid())
  tenantId   String
  tenant     Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  brokerId   String
  broker     Broker         @relation(fields: [brokerId], references: [id], onDelete: Cascade)
  reviewerId String?
  reviewer   User?          @relation("ReviewerReviews", fields: [reviewerId], references: [id])
  decision   ReviewDecision @default(pending)
  notes      String?
  decidedAt  DateTime?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  @@index([tenantId])
  @@index([brokerId])
  @@index([decision])
  @@index([reviewerId])
}

model QrCode {
  id            String       @id @default(uuid())
  tenantId      String
  tenant        Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  code          String       @unique
  status        QrCodeStatus @default(active)
  qrSvgUrl      String?
  metadata      Json?
  scanCount     Int          @default(0)
  lastScannedAt DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  broker        Broker?      @relation("BrokerQrCode")
  inspections   Inspection[]

  @@index([tenantId])
  @@index([status])
}

model Inspection {
  id                 String           @id @default(uuid())
  tenantId           String
  tenant             Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  inspectorUserId    String
  inspector          User             @relation("InspectorInspections", fields: [inspectorUserId], references: [id], onDelete: Cascade)
  qrCodeId           String?
  qrCode             QrCode?          @relation(fields: [qrCodeId], references: [id])
  brokerId           String?
  broker             Broker?          @relation(fields: [brokerId], references: [id])
  verificationResult Json?
  violationType      String?
  violationNotes     String?
  location           Json?
  photos             Json?
  status             InspectionStatus @default(synced)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  @@index([tenantId])
  @@index([inspectorUserId])
  @@index([brokerId])
  @@index([status])
}

model AuditLog {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  actorUserId String?
  actor       User?    @relation(fields: [actorUserId], references: [id])
  entityType  String
  entityId    String
  action      String
  before      Json?
  after       Json?
  createdAt   DateTime @default(now())

  @@index([tenantId])
  @@index([actorUserId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

// Billing Models
model PaymentProvider {
  id         String              @id @default(uuid())
  tenantId   String
  tenant     Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  providerId String // e.g., "stripe", "telebirr", "mpesa", "cash"
  type       PaymentProviderType
  audience   String? // "broker", "tenant", "both", etc.
  name       String
  config     Json // Provider-specific configuration (API keys, endpoints, etc.)
  isActive   Boolean             @default(true)
  isDefault  Boolean             @default(false)
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt

  plans          Plan[]
  subscriptions  Subscription[]
  paymentIntents PaymentIntent[]
  invoices       Invoice[]

  @@unique([tenantId, providerId])
  @@index([tenantId])
  @@index([providerId])
  @@index([tenantId, providerId])
}

model Plan {
  id              String          @id @default(uuid())
  tenantId        String
  tenant          Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  providerId      String
  provider        PaymentProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  audience        String? // "broker", "tenant", "both", etc.
  planId          String // External plan ID from provider (e.g., Stripe plan ID)
  name            String
  description     String?
  amount          Decimal         @db.Decimal(12, 2)
  currency        String
  interval        String // "month", "year", "one_time"
  intervalCount   Int             @default(1)
  trialPeriodDays Int?
  isActive        Boolean         @default(true)
  metadata        Json?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  subscriptions Subscription[]

  @@unique([tenantId, planId])
  @@index([tenantId])
  @@index([providerId])
  @@index([tenantId, planId])
}

model Subscription {
  id                 String             @id @default(uuid())
  tenantId           String
  tenant             Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  providerId         String
  provider           PaymentProvider    @relation(fields: [providerId], references: [id], onDelete: Cascade)
  planId             String
  plan               Plan               @relation(fields: [planId], references: [id], onDelete: Restrict)
  audience           String? // "broker", "tenant", etc.
  subscriberId       String // ID of the subscribed entity (broker ID, tenant ID, etc.)
  subscriberType     String // "broker", "tenant", etc.
  subscriptionId     String? // External subscription ID from provider
  status             SubscriptionStatus @default(active)
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean            @default(false)
  canceledAt         DateTime?
  trialStart         DateTime?
  trialEnd           DateTime?
  metadata           Json?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  invoices Invoice[]

  @@index([tenantId])
  @@index([providerId])
  @@index([subscriberId, subscriberType])
  @@index([status])
  @@index([tenantId, subscriberId, subscriberType])
}

model Invoice {
  id             String          @id @default(uuid())
  tenantId       String
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  providerId     String
  provider       PaymentProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  subscriptionId String?
  subscription   Subscription?   @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  audience       String? // "broker", "tenant", etc.
  customerId     String // ID of the customer (broker ID, tenant ID, etc.)
  customerType   String // "broker", "tenant", etc.
  invoiceId      String? // External invoice ID from provider
  invoiceNumber  String // Internal invoice number
  status         InvoiceStatus   @default(draft)
  amount         Decimal         @db.Decimal(12, 2)
  currency       String
  paidAmount     Decimal?        @db.Decimal(12, 2)
  dueDate        DateTime?
  paidAt         DateTime?
  metadata       Json?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  paymentIntents PaymentIntent[]

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId])
  @@index([providerId])
  @@index([subscriptionId])
  @@index([customerId, customerType])
  @@index([status])
  @@index([invoiceNumber])
}

model PaymentIntent {
  id             String              @id @default(uuid())
  tenantId       String
  tenant         Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  providerId     String
  provider       PaymentProvider     @relation(fields: [providerId], references: [id], onDelete: Cascade)
  invoiceId      String?
  invoice        Invoice?            @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  audience       String? // "broker", "tenant", etc.
  customerId     String // ID of the customer
  customerType   String // "broker", "tenant", etc.
  intentId       String? // External payment intent ID from provider
  status         PaymentIntentStatus @default(requires_payment_method)
  amount         Decimal             @db.Decimal(12, 2)
  currency       String
  capturedAmount Decimal?            @db.Decimal(12, 2)
  refundedAmount Decimal?            @db.Decimal(12, 2)
  metadata       Json?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  @@index([tenantId])
  @@index([providerId])
  @@index([invoiceId])
  @@index([customerId, customerType])
  @@index([status])
  @@index([intentId])
}

model DunningRule {
  id           String        @id @default(uuid())
  tenantId     String
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  audience     String? // "broker", "tenant", etc.
  name         String
  description  String?
  daysAfterDue Int // Days after due date to trigger
  action       DunningAction @default(send_notice)
  maxAttempts  Int           @default(3)
  isActive     Boolean       @default(true)
  metadata     Json?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([tenantId])
  @@index([audience])
  @@index([isActive])
}

model Inquiry {
  id             String    @id @default(uuid())
  tenantId       String
  listingId      String
  brokerUserId   String
  fullName       String
  email          String
  phone          String?
  message        String    @db.Text
  source         String
  status         String    @default("NEW")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  lastBrokerView DateTime?
  brokerNotes    String?   @db.Text

  @@index([tenantId])
  @@index([listingId])
  @@index([brokerUserId])
  @@index([tenantId, status])
  @@index([brokerUserId, status])
}

model Lead {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  source      String   // e.g., 'SELL_PAGE'
  payloadJson Json     // Store full lead data as JSON
  status      String   @default("NEW")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@index([source])
  @@index([status])
  @@index([tenantId, status])
  @@index([createdAt])
}

model PlatformSettings {
  id        Boolean   @id @default(true)
  version   Int       @default(1)
  settings  Json      @db.JsonB
  updatedBy String    @map("updated_by")
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at")

  @@map("platform_settings")
}

model SuperSettingsAudit {
  id        String   @id @default(uuid())
  version   Int
  settings  Json     @db.JsonB
  updatedBy String   @map("updated_by")
  updatedAt DateTime @default(now()) @map("updated_at")

  @@index([updatedAt])
  @@index([updatedBy])
  @@map("super_settings_audit")
}

model TenantPolicy {
  id        String   @id @default(uuid())
  tenantId  String   @unique
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  version   Int      @default(1)
  overrides Json     @db.JsonB
  updatedBy String   @map("updated_by")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@index([tenantId])
  @@map("tenant_policy")
}
